FROM --platform=linux/amd64 pytorch/pytorch:2.5.1-cuda12.4-cudnn9-devel

ENV DEBIAN_FRONTEND=noninteractive
ENV FASTAI_VENV=/opt/fastai-venv
ENV PATH="$FASTAI_VENV/bin:$PATH"

# Layer 1: All system deps + Node.js (single apt-get update)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git openssh-client graphviz vim curl wget fonts-noto-cjk && \
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y --no-install-recommends nodejs && \
    rm -rf /var/lib/apt/lists/*

# Layer 2: Python venv + all packages + Claude Code CLI
# --system-site-packages inherits PyTorch/torchvision/torchaudio from base image (~2GB saving)
RUN python -m venv --system-site-packages $FASTAI_VENV && \
    pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
        fastai fastcore fastdownload fastbook fastkaggle \
        transformers tokenizers accelerate \
        diffusers bitsandbytes peft safetensors \
        timm \
        matplotlib numpy pandas scipy scikit-learn \
        seaborn plotly graphviz dtreeviz \
        sympy networkx \
        datasets sentencepiece \
        gradio \
        jupyterlab notebook ipykernel ipywidgets \
        nbdev && \
    python -m ipykernel install --name fastai --display-name "FastAI (venv)" && \
    npm install -g @anthropic-ai/claude-code

# Layer 3: Clone course repo (placed late â€” repo updates won't invalidate package cache)
RUN git clone https://github.com/goosmanlei/fastai-course-part2.git /root/fastai-course-part2

# Layer 4: All configuration (matplotlib, Jupyter, git, shell)
RUN mkdir -p /root/.config/matplotlib /root/.jupyter && \
    printf "font.family : Noto Sans CJK SC\naxes.unicode_minus : False\n" \
        > /root/.config/matplotlib/matplotlibrc && \
    { echo "c.ServerApp.ip = '0.0.0.0'"; \
      echo "c.ServerApp.port = 8888"; \
      echo "c.ServerApp.allow_root = True"; \
      echo "c.ServerApp.token = ''"; \
      echo "c.ServerApp.allow_origin = '*'"; \
      echo "c.ServerApp.allow_remote_access = True"; \
      echo "c.ServerApp.disable_check_xsrf = True"; \
      echo "c.ServerApp.root_dir = '/root/fastai-course-part2'"; \
    } > /root/.jupyter/jupyter_lab_config.py && \
    git config --global user.email "leiguoguo.ai@gmail.com" && \
    git config --global user.name "goosmanlei" && \
    git config --global alias.co checkout && \
    git config --global alias.br branch && \
    git config --global alias.ci commit && \
    git config --global alias.st status && \
    chsh -s /bin/bash root && \
    echo 'source /opt/fastai-venv/bin/activate' >> /root/.bashrc

EXPOSE 8888

CMD ["jupyter", "lab"]
